<div class="pb-2" *ngIf="backlog">
  <div class="d-flex justify-content-between mb-3">
    <h4 class="mb-0">Бэклог</h4>
    <div class="text-right">
      <div class="btn btn-outline-primary" (click)="onCreatTask()">Создать задачу</div>
      <div class="btn btn-primary ml-2" (click)="onCreateSprint()">Создать спринт</div>
    </div>
  </div>
  <div class="content rounded p-2 mb-2" *ngFor="let sprint of backlog.sprints">
    <div
      [ngClass]="{ 'mb-3': sprint.isOpened }"
      class="header d-flex justify-content-between align-items-center"
    >
      <div class="name" (click)="toggleSprint(sprint)">
        <span class="d-block mr-2"
          ><i class="fas fa-chevron-right mr-2" [ngClass]="{ opened: sprint.isOpened }"></i
          >{{ sprint.name }}</span
        ><span class="badge badge-success" *ngIf="sprint.isActive">Активный</span>
      </div>

      <ng-container *ngIf="!sprint.isFinished">
        <button
          class="btn btn-success"
          *ngIf="!sprint.planningId && !sprint.isActive && sprint.tasks?.length"
          (click)="onStartPlanning(sprint.id)"
        >
          Оценить задачи
        </button>
        <button
          class="btn btn-outline-success"
          *ngIf="!sprint.isActive && !sprint.isFinished && sprint.planningId"
          [routerLink]="['../planning', sprint.planningId]"
        >
          Перейти к планированию
        </button>
        <ng-container *ngIf="sprint.isActive">
          <button
            *ngIf="!sprint.demo?.isFinished"
            class="btn btn-outline-info"
            [routerLink]="['../planning', sprint.planningId]"
          >
            Начать демо
          </button>
          <button
            class="btn btn-outline-primary ml-2"
            [routerLink]="['../planning', sprint.planningId]"
          >
            Начать ретроспективу
          </button></ng-container
        >
      </ng-container>
    </div>
    <ng-container *ngIf="sprint.isOpened"
      ><ng-container *ngIf="sprint.tasks?.length; else noData">
        <ng-container *ngFor="let task of sprint.tasks">
          <ng-container
            *ngTemplateOutlet="
              taskTemp;
              context: {
                $implicit: task,
                showBtn: !sprint.isActive && !!projectDataService.project?.sprint
              }
            "
          ></ng-container>
        </ng-container> </ng-container
    ></ng-container>
  </div>
  <div class="content rounded p-2" *ngIf="backlog.tasks?.length">
    <div class="header mb-3">Задачи без спринта</div>
    <ng-container *ngIf="backlog.tasks?.length; else noData">
      <ng-container *ngFor="let task of backlog.tasks">
        <ng-container
          *ngTemplateOutlet="
            taskTemp;
            context: { $implicit: task, showBtn: !!projectDataService.project?.sprint }
          "
        ></ng-container>
      </ng-container>
    </ng-container>
  </div>
</div>

<ng-template #noData>
  <div class="d-flex justify-content-center align-items-center text-muted p-4">
    Задачи отсутствуют
  </div>
</ng-template>

<ng-template #taskTemp let-task let-show="showBtn">
  <div class="task rounded d-flex">
    <div class="col-8 d-flex align-items-center">
      <small class="text-muted mr-3">#{{ task.id }}</small>
      <a [routerLink]="['/task', task.id]"
        ><h6 class="d-inline text-dark mb-0">{{ task.name }}</h6></a
      >
    </div>
    <div class="col-4 pr-0 d-flex align-items-center justify-content-end">
      <small class="text-muted">{{ task.projectUser?.name }} {{ task.projectUser?.surname }}</small>
      <button
        *ngIf="show"
        class="btn icon-btn ml-3"
        title="Добавить в текущий спринт"
        (click)="onAddToActiveSprint(task.id)"
      >
        <i class="far fa-plus-square"></i>
      </button>
    </div>
  </div>
</ng-template>
