<ng-container *ngIf="demo">
  <div class="d-flex justify-content-between mb-3 pr-2">
    <h4 class="mb-0">Демо спринта "{{ demo.sprintName }}"</h4>
    <div class="text-right">
      <div
        class="btn"
        [ngClass]="{
          'btn-outline-primary': demo.taskToShow?.length,
          'btn-primary': !demo.taskToShow?.length
        }"
        (click)="finishDemo(false, createDemoTask)"
        *ngIf="this.projectDataService.PID[this.permissions.CanStartDemo] && !demo.isFinished"
      >
        Завершить демо
      </div>
      <button class="btn btn-outline-primary ml-2" (click)="openNotes(createDemoTask)">
        <i class="fas fa-align-left"></i>
      </button>
    </div>
  </div>
  <div class="d-flex">
    <div class="tasks w-25">
      <div class="content rounded p-2 mb-2 w-100" *ngIf="demo.taskToShow?.length">
        <div
          [ngClass]="{ 'mb-2': true }"
          class="header d-flex justify-content-between align-items-center"
        >
          <div class="name">
            <span class="d-block mr-2">
              <i class="fas fa-chevron-right mr-2" [ngClass]="{ opened: true }"></i>
              Задачи для показа
            </span>
          </div>
        </div>

        <ng-container *ngFor="let task of demo.taskToShow">
          <ng-container
            *ngTemplateOutlet="
              taskTemp;
              context: {
                $implicit: task,
                showBtn: false
              }
            "
          ></ng-container>
        </ng-container>
      </div>
      <div class="content rounded p-2 mb-2 w-100" *ngIf="demo.shownTasks?.length">
        <div
          [ngClass]="{ 'mb-2': true }"
          class="header d-flex justify-content-between align-items-center"
        >
          <div class="name">
            <span class="d-block mr-2">
              <i class="fas fa-chevron-right mr-2" [ngClass]="{ opened: true }"></i>
              Принятые задачи
            </span>
          </div>
        </div>

        <ng-container *ngFor="let task of demo.shownTasks">
          <ng-container
            *ngTemplateOutlet="
              taskTemp;
              context: {
                $implicit: task,
                showBtn: false
              }
            "
          ></ng-container>
        </ng-container>
      </div>
    </div>
    <div class="active-task w-75 pl-2">
      <div class="mb-3" *ngIf="activeTask">
        <div class="task pb-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">
              {{ activeTask.task.name }}
              <span
                class="badge"
                [ngClass]="{
                  'badge-success': activeTask.task.status.id !== 1,
                  'badge-secondary': activeTask.task.status.id === 1
                }"
                *ngIf="activeTask.isFinished"
                >{{ activeTask.task.status.id === 1 ? 'Переоткрыта' : 'Принята' }}</span
              >
            </h4>
            <div class="d-flex justify-content-end align-items-center">
              <button
                class="btn btn-outline-secondary"
                (click)="reopenTask(activeTask.id)"
                *ngIf="
                  this.projectDataService.PID[this.permissions.CanEditTask] &&
                  !activeTask.isFinished
                "
              >
                Переоткрыть
              </button>
              <button
                class="btn btn-primary ml-2"
                (click)="acceptTask(activeTask.id)"
                *ngIf="
                  this.projectDataService.PID[this.permissions.CanStartDemo] &&
                  !activeTask.isFinished &&
                  canAcceptTask()
                "
              >
                Принять
              </button>
            </div>
          </div>

          <div class="form-group">
            <small class="text-muted">Описание</small>
            <p [innerHTML]="activeTask.task.description"></p>
          </div>
          <div class="form-group" *ngIf="activeTask.task.files?.length">
            <small class="text-muted">Вложения</small>
            <app-multiple-file-uploader
              [files]="getTaskFiles(activeTask.task)"
              (download)="downloadFile($event)"
              [disabled]="true"
            ></app-multiple-file-uploader>
          </div>

          <div class="row">
            <div class="col-4">
              <div class="form-group">
                <small class="text-muted">Приоритет</small>
                <h6>{{ activeTask.task.priorityId | priority }}</h6>
              </div>
            </div>
            <div class="col-4">
              <div class="form-group">
                <small class="text-muted">Тип задачи</small>
                <h6>{{ activeTask.task.typeId | taskType }}</h6>
              </div>
            </div>
          </div>
        </div>
        <ul
          class="nav nav-pills mt-3 py-3 border-top"
          *ngIf="activeTask?.task.criteria?.length || activeTask?.task.comments?.length"
        >
          <li class="nav-item">
            <button
              *ngIf="activeTask?.task.criteria?.length"
              class="btn nav-link"
              [ngClass]="{ active: activeTab === 1 }"
              (click)="activeTab = 1"
            >
              Критерии приемки
            </button>
          </li>
          <li class="nav-item">
            <button
              *ngIf="activeTask?.task.comments?.length"
              class="btn nav-link"
              [ngClass]="{ active: activeTab === 2 }"
              (click)="activeTab = 2"
            >
              Комментарии
            </button>
          </li>
        </ul>
        <ng-container [ngSwitch]="activeTab">
          <app-task-acceptance-criteria
            *ngSwitchCase="1"
            [staticView]="true"
            [criterias]="activeTask.task.criteria"
            (done)="saveDoneCriteria($event)"
          ></app-task-acceptance-criteria>
          <app-task-comments
            *ngSwitchCase="2"
            [staticView]="true"
            [comments]="activeTask.task.comments"
          ></app-task-comments>
        </ng-container>
      </div>

      <!-- <div
        class="ml-2 mt-3 py-3 border-top"
        *ngIf="this.projectDataService.PID[this.permissions.CanCreateDemoNotes]"
      >
        <div class="form-group">
          <p class="mb-1">Замечания:</p>
          <ckeditor [editor]="editor" [formControl]="commentControl"></ckeditor>
        </div>

        <p class="mb-1">
          Вложения
          <i class="fas fa-link ml-1 cursor-pointer" (click)="uploader.uploadFiles($event)"></i>
        </p>
        <app-multiple-file-uploader
          [formControl]="filesControl"
          #uploader
        ></app-multiple-file-uploader>
      </div> -->
    </div>
  </div>
</ng-container>

<ng-template #taskTemp let-task let-show="showBtn">
  <div
    class="task rounded w-100 d-flex flex-column justify-content-center"
    [ngClass]="{ active: activeTask?.id === task.id }"
    (click)="onTaskClick(task.id)"
  >
    <small class="text-muted mr-3">#{{ task.task.id }}</small>
    <h6 class="d-inline text-dark">{{ task.task.name }}</h6>
    <div class="d-flex mb-2">
      <div class="mr-1" [taskType]="task.task.typeId">{{ task.task.typeId | taskType }}</div>
      <div class="mr-1" [taskPriority]="task.task.priorityId">
        {{ task.task.priorityId | priority }}
      </div>
    </div>
    <div
      class="badge d-block w-100"
      *ngIf="task.task.epic"
      [ngClass]="{'text-dark': activeTask?.id !== task.id}"
      [ngStyle]="{
        border: '1px solid' + task.task.epic?.color,
        'border-left': '10px solid' + task.task.epic?.color
      }"
    >
      {{ task.task.epic.name }}
    </div>
  </div>
</ng-template>

<ng-template #noData>
  <div class="d-flex justify-content-center align-items-center text-muted w-100 h-100">
    Задача не выбрана
  </div>
</ng-template>

<ng-template #createDemoTask>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-title">Создание задачи с замечаниями</h4>
    <button
      type="button"
      class="close"
      aria-label="Close button"
      aria-describedby="modal-title"
      (click)="modalService.dismissAll()"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div class="modal-body" [formGroup]="demoTaskForm">
    <div class="form-group">
      <label>Название задачи</label>
      <input
        type="text"
        class="form-control"
        formControlName="name"
        placeholder="Название"
        ngbAutofocus
      />
    </div>

    <div class="form-group">
      <label>Описание</label>
      <ckeditor [editor]="editor" formControlName="comment"></ckeditor>
    </div>
    <div class="form-group">
      <label
        >Вложения<i
          class="fas fa-link ml-1 cursor-pointer"
          (click)="formUploader.uploadFiles($event)"
        ></i
      ></label>
      <app-multiple-file-uploader
        formControlName="files"
        #formUploader
      ></app-multiple-file-uploader>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-outline-primary" (click)="finishDemoWithoutTask()">
      Завершить демо
    </button>
    <button class="btn btn-primary" (click)="finishDemo(true)">
      Создать задачу и завершить демо
    </button>
  </div>
</ng-template>
